<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>æ¨ç®±å­ @ å­™ç»´åˆšæ•™è‚²ç ”ç©¶é™¢</title>
  <style>
    /* â€”â€” å…¨å±€è®¾ç½® â€”â€” */
    :root {
      --bg-color: #f0f2f5;
      --control-bg: rgba(255, 255, 255, 0.95);
      --primary-color: #007AFF;
      --btn-active: #0056b3;
      --text-color: #333;
      --wall-color: #555;
      --floor-color: #fffaf0;
    }

    /* ====== ç§‘æŠ€åºŸåœŸä¸»é¢˜ (Wasteland Theme) ====== 
       å½“ body æ‹¥æœ‰ .theme-wasteland ç±»æ—¶ç”Ÿæ•ˆ
    */
    body.theme-wasteland {
      --bg-color: #050a10; /* æ·±ç©ºé»‘ */
      --control-bg: rgba(10, 15, 25, 0.95);
      --primary-color: #00f3ff; /* èµ›åšé’è“ */
      --btn-active: #00bcd4;
      --text-color: #b8e6e8;
      --wall-color: #1a2634;
      --floor-color: #0d1218;
      
      /* ç§‘æŠ€æ„ŸèƒŒæ™¯ç½‘æ ¼ */
      background-image: 
        linear-gradient(rgba(0, 243, 255, 0.05) 1px, transparent 1px),
        linear-gradient(90deg, rgba(0, 243, 255, 0.05) 1px, transparent 1px);
      background-size: 30px 30px;
    }

    body {
      margin: 0;
      padding: 0;
      background-color: var(--bg-color);
      color: var(--text-color);
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      height: 100vh;
      height: 100dvh;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      user-select: none;
      -webkit-user-select: none;
      transition: background-color 0.5s ease;
    }

    /* â€”â€” é¡¶éƒ¨åŒºåŸŸï¼šæ ‡é¢˜ä¸å…³å¡é€‰æ‹© â€”â€” */
    header {
      padding: 10px 0;
      background: var(--control-bg); /* è·Ÿéšä¸»é¢˜ */
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      z-index: 10;
      flex-shrink: 0;
      display: flex;
      flex-direction: column;
      gap: 5px;
      transition: background 0.5s;
    }

    h1 {
      margin: 5px 0 5px 0;
      font-size: 1.1rem;
      color: var(--text-color); /* è·Ÿéšä¸»é¢˜ */
      text-align: center;
    }

    /* å…³å¡é€‰æ‹©å™¨ï¼šä¼˜åŒ–æ»šåŠ¨æ˜¾ç¤º */
    #level-scroll-container {
      display: flex;
      overflow-x: auto;
      gap: 12px;
      padding: 5px 15px 15px 15px;
      -webkit-overflow-scrolling: touch;
      scrollbar-width: none;
    }
    #level-scroll-container::-webkit-scrollbar {
      display: none;
    }

    .level-btn {
      flex: 0 0 auto;
      padding: 8px 18px;
      font-size: 14px;
      border-radius: 20px;
      border: 1px solid #eee;
      background-color: #fff;
      color: #555;
      cursor: pointer;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
      transition: all 0.2s;
    }

    /* åºŸåœŸä¸»é¢˜ä¸‹çš„æŒ‰é’®æ ·å¼ */
    body.theme-wasteland .level-btn {
      background-color: #21262d;
      border-color: #30363d;
      color: #8b949e;
    }

    .level-btn.active {
      background-color: var(--primary-color);
      color: white;
      border-color: var(--primary-color);
      box-shadow: 0 3px 8px rgba(0, 122, 255, 0.3);
      transform: translateY(-1px);
    }
    
    /* åºŸåœŸä¸»é¢˜æ¿€æ´»æŒ‰é’® */
    body.theme-wasteland .level-btn.active {
      color: #0d1117;
      box-shadow: 0 0 10px rgba(0, 255, 157, 0.4);
    }

    /* â€”â€” æ¸¸æˆä¸»åŒºåŸŸ â€”â€” */
    #game-container {
      flex: 1;
      display: flex;
      justify-content: center;
      align-items: center;
      position: relative;
      overflow: hidden;
      background-color: #e8e8e8;
      margin: 10px;
      border-radius: 12px;
      box-shadow: inset 0 0 15px rgba(0,0,0,0.05);
      transition: background-color 0.5s;
    }
    
    /* åºŸåœŸä¸»é¢˜å®¹å™¨èƒŒæ™¯ */
    body.theme-wasteland #game-container {
      background-color: #080c10;
      box-shadow: 0 0 30px rgba(0, 243, 255, 0.1), inset 0 0 50px rgba(0, 0, 0, 0.8);
      border: 1px solid #1f2f3f;
    }

    #game-board {
      display: grid;
      gap: 1px;
      background-color: #bbb;
      flex: none; 
      transition: background-color 0.5s;
    }
    body.theme-wasteland #game-board {
      background-color: #30363d;
      gap: 2px; /* å¢åŠ ä¸€ç‚¹ç¼éš™æ„Ÿ */
    }

    /* çŠ¶æ€æç¤ºæµ®å±‚ */
    #status-overlay {
      position: absolute;
      top: 15px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0, 0, 0, 0.8);
      color: #fff;
      padding: 8px 20px;
      border-radius: 20px;
      font-size: 15px;
      pointer-events: none;
      opacity: 0;
      transition: opacity 0.3s;
      z-index: 20;
      white-space: nowrap;
    }
    body.theme-wasteland #status-overlay {
      background: rgba(0, 255, 157, 0.2);
      border: 1px solid #00ff9d;
      color: #00ff9d;
      text-shadow: 0 0 5px #00ff9d;
    }
    #status-overlay.show {
      opacity: 1;
    }

    /* â€”â€” åœ°å›¾å…ƒç´ æ ·å¼ â€”â€” */
    .tile {
      background-color: #fff;
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
      aspect-ratio: 1 / 1; 
      width: 100%;
      height: 100%;
      box-sizing: border-box;
    }

    /* å¢™å£ */
    .wall {
      background-color: #555;
      background-image: linear-gradient(45deg, #666 25%, transparent 25%, transparent 75%, #666 75%, #666),
                        linear-gradient(45deg, #666 25%, transparent 25%, transparent 75%, #666 75%, #666);
      background-size: 12px 12px;
    }
    /* åºŸåœŸä¸»é¢˜ï¼šé«˜ç§‘æŠ€å¢™å£ */
    body.theme-wasteland .wall {
      background-color: #121820;
      background-image: none;
      border: 1px solid #00f3ff;
      box-shadow: 0 0 8px rgba(0, 243, 255, 0.15), inset 0 0 10px rgba(0,0,0,0.5);
      position: relative;
    }
    /* ç»™å¢™å£åŠ ä¸€ç‚¹ç”µè·¯çº¹ç† (ä¼ªå…ƒç´ ) */
    body.theme-wasteland .wall::after {
      content: "";
      position: absolute;
      top: 15%; left: 15%; right: 15%; bottom: 15%;
      border: 1px solid rgba(0, 243, 255, 0.2);
      border-radius: 2px;
      box-shadow: inset 0 0 4px rgba(0, 243, 255, 0.1);
    }

    /* å¢™å¤– */
    .outside { background-color: transparent; }
    
    /* åœ°æ¿ */
    .floor { background-color: var(--floor-color); }
    
    /* ç›®æ ‡ç‚¹ï¼ˆçº¢ç‚¹ï¼‰ï¼šç»å¯¹å®šä½åœ¨åº•å±‚ */
    .goal::after {
      content: "";
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 50%;
      height: 50%;
      background-color: #ff3333;
      border-radius: 50%;
      z-index: 1; 
      opacity: 0.6;
    }
    /* åºŸåœŸä¸»é¢˜ï¼šèƒ½é‡ç”µæ± èˆ± (æ–¹å½¢æ’æ§½) */
    body.theme-wasteland .goal::after {
      background-color: rgba(0, 243, 255, 0.05);
      border: 2px dashed #00f3ff;
      border-radius: 4px;
      width: 60%;
      height: 60%;
      box-shadow: inset 0 0 10px rgba(0, 243, 255, 0.2);
      animation: pulse-chamber 2s infinite;
    }
    @keyframes pulse-chamber {
      0% { box-shadow: inset 0 0 5px rgba(0, 243, 255, 0.1); opacity: 0.5; }
      50% { box-shadow: inset 0 0 15px rgba(0, 243, 255, 0.4); opacity: 1; }
      100% { box-shadow: inset 0 0 5px rgba(0, 243, 255, 0.1); opacity: 0.5; }
    }

    /* ç©å®¶ï¼šå·¥äºº */
    .player::before {
      content: "ğŸ‘·";
      position: relative;
      z-index: 5;
      filter: drop-shadow(0 2px 2px rgba(0,0,0,0.3));
    }
    /* åºŸåœŸä¸»é¢˜ï¼šå…¨å‰¯æ­¦è£…æˆ˜å£« (å¤ªç©ºäººå›¾æ ‡æ›¿ä»£) */
    body.theme-wasteland .player::before {
      content: "ğŸ§‘â€ğŸš€";
      filter: drop-shadow(0 0 10px #00f3ff);
      font-size: 1.1em;
    }

    /* ç®±å­ */
    .box::before {
      content: "ğŸ“¦";
      position: relative;
      z-index: 5;
      filter: drop-shadow(0 2px 2px rgba(0,0,0,0.2));
    }
    /* åºŸåœŸä¸»é¢˜ï¼šç§‘æŠ€ç”µæ± å— */
    body.theme-wasteland .box::before {
      content: "ğŸ”‹";
      filter: drop-shadow(0 0 4px #00f3ff) hue-rotate(180deg); /* è°ƒæ•´ç”µæ± è‰²ç›¸åŒ¹é… */
      font-size: 0.9em;
      transform: rotate(-90deg); /* è®©ç”µæ± ç«–èµ·æ¥æˆ–è€…æ¨ªç€ï¼Œçœ‹å–œå¥½ï¼Œè¿™é‡Œé»˜è®¤ */
    }

    /* ç®±å­åœ¨ç›®æ ‡ç‚¹ä¸Š */
    .box-on-goal {
      background-color: #ccffcc;
    }
    .box-on-goal::before {
      content: "ğŸ“¦";
      position: relative;
      z-index: 5;
      filter: drop-shadow(0 0 5px rgba(0,255,0,0.5));
    }
    /* åºŸåœŸä¸»é¢˜ï¼šæ¿€æ´»çš„èƒ½é‡ç”µæ±  */
    body.theme-wasteland .box-on-goal {
      background-color: rgba(0, 243, 255, 0.3);
      box-shadow: 0 0 20px rgba(0, 243, 255, 0.3);
    }
    body.theme-wasteland .box-on-goal::before {
      content: "ğŸ”‹";
      filter: drop-shadow(0 0 15px #ffffff) brightness(1.3);
    }

    /* â€”â€” åº•éƒ¨æ§åˆ¶åŒº â€”â€” */
    #controls-area {
      background-color: var(--control-bg);
      padding: 10px 20px 20px 20px;
      border-top-left-radius: 25px;
      border-top-right-radius: 25px;
      box-shadow: 0 -5px 20px rgba(0,0,0,0.05);
      flex-shrink: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      backdrop-filter: blur(10px);
      transition: background-color 0.5s;
    }
    body.theme-wasteland #controls-area {
      box-shadow: 0 -5px 20px rgba(0, 255, 157, 0.05);
      border-top: 1px solid #30363d;
    }

    /* åŠŸèƒ½æŒ‰é’®è¡Œ */
    .action-row {
      display: flex;
      width: 100%;
      justify-content: space-between;
      margin-bottom: 15px;
    }

    .func-btn {
      padding: 10px 18px;
      border: none;
      border-radius: 12px;
      font-size: 15px;
      font-weight: 600;
      background-color: #f1f3f5;
      color: #495057;
      display: flex;
      align-items: center;
      gap: 6px;
      box-shadow: 0 2px 0 #dee2e6;
    }
    .func-btn:active { transform: translateY(2px); box-shadow: none; }
    
    /* åºŸåœŸä¸»é¢˜åŠŸèƒ½æŒ‰é’® */
    body.theme-wasteland .func-btn {
      background-color: #21262d;
      color: var(--primary-color);
      box-shadow: 0 2px 0 #30363d;
      border: 1px solid #30363d;
    }

    .btn-undo { color: #d63384; background-color: #fff0f6; box-shadow: 0 2px 0 #fcc2d7; }
    .btn-restart { color: #fd7e14; background-color: #fff4e6; box-shadow: 0 2px 0 #ffe8cc; }
    
    /* åºŸåœŸä¸»é¢˜ç‰¹å®šæŒ‰é’®è¦†ç›– */
    body.theme-wasteland .btn-undo { color: #ff79c6; background-color: #21262d; box-shadow: 0 2px 0 #444; }
    body.theme-wasteland .btn-restart { color: #ffb86c; background-color: #21262d; box-shadow: 0 2px 0 #444; }

    /* æ–¹å‘ç›˜å¸ƒå±€ */
    #dpad {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      grid-template-rows: repeat(2, 1fr);
      gap: 12px;
      width: 200px;
      height: 140px;
    }

    .dpad-btn {
      width: 100%;
      height: 100%;
      border: none;
      border-radius: 16px;
      background-color: #fff;
      color: #333;
      font-size: 26px;
      box-shadow: 0 4px 0 #e9ecef, 0 2px 5px rgba(0,0,0,0.05);
      transition: all 0.1s;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .dpad-btn:active {
      transform: translateY(4px);
      box-shadow: inset 0 2px 4px rgba(0,0,0,0.05);
      background-color: #f8f9fa;
    }

    /* åºŸåœŸä¸»é¢˜æ–¹å‘é”® */
    body.theme-wasteland .dpad-btn {
      background-color: #21262d;
      color: var(--primary-color);
      box-shadow: 0 4px 0 #000;
    }
    body.theme-wasteland .dpad-btn:active {
      background-color: #161b22;
      box-shadow: inset 0 2px 4px #000;
    }

    #btn-up { grid-column: 2; grid-row: 1; }
    #btn-left { grid-column: 1; grid-row: 2; }
    #btn-down { grid-column: 2; grid-row: 2; }
    #btn-right { grid-column: 3; grid-row: 2; }

    /* â€”â€” åº•éƒ¨æ–‡å­— â€”â€” */
    .footer-info {
      font-size: 12px;
      color: #adb5bd;
      margin-top: 15px;
      text-align: center;
      width: 100%;
      font-weight: 400;
    }
    body.theme-wasteland .footer-info {
      color: #484f58;
    }

    /* â€”â€” è‡ªå®šä¹‰åœ°å›¾æ¨¡æ€æ¡† & å¯†ç æ¨¡æ€æ¡† â€”â€” */
    #custom-map-modal, #password-modal {
      display: none;
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.5);
      z-index: 100;
      align-items: center;
      justify-content: center;
      backdrop-filter: blur(3px);
    }
    .modal-content {
      background: white;
      padding: 24px;
      border-radius: 20px;
      width: 85%;
      max-width: 400px;
      box-shadow: 0 10px 25px rgba(0,0,0,0.1);
    }
    textarea {
      width: 100%;
      height: 120px;
      margin: 15px 0;
      font-family: monospace;
      padding: 10px;
      border: 2px solid #eee;
      border-radius: 10px;
      box-sizing: border-box;
      resize: none;
    }
    .modal-actions {
      display: flex;
      justify-content: flex-end;
      gap: 12px;
    }

  </style>
</head>
<body>

  <!-- å¤´éƒ¨ -->
  <header>
    <h1>æ¨ç®±å­</h1>
    <div id="level-scroll-container">
      <!-- å…³å¡æŒ‰é’®ç”± JS ç”Ÿæˆ -->
    </div>
  </header>

  <!-- æ¸¸æˆåŒºåŸŸ -->
  <div id="game-container">
    <div id="game-board"></div>
    <div id="status-overlay"></div> <!-- èƒœåˆ©æç¤º -->
  </div>

  <!-- åº•éƒ¨æ“ä½œåŒº -->
  <div id="controls-area">
    <div class="action-row">
      <button class="func-btn extra-btn" id="btn-show-custom">ğŸ—ºï¸ è‡ªå®šä¹‰</button>
      <div style="flex:1"></div>
      <button class="func-btn btn-undo" id="btn-undo">â†©ï¸ æ’¤å›</button>
      <button class="func-btn btn-restart" id="btn-restart">ğŸ”„ é‡ç©</button>
    </div>

    <div id="dpad">
      <!-- ç©ºå ä½ -->
      <div style="grid-column: 1; grid-row: 1;"></div>
      <button class="dpad-btn" id="btn-up">â–²</button>
      <div style="grid-column: 3; grid-row: 1;"></div>
      
      <button class="dpad-btn" id="btn-left">â—€</button>
      <button class="dpad-btn" id="btn-down">â–¼</button>
      <button class="dpad-btn" id="btn-right">â–¶</button>
    </div>

    <!-- åº•éƒ¨ç‰ˆæƒä¿¡æ¯ -->
    <div class="footer-info">@å­™ç»´åˆšæ•™è‚²ç ”ç©¶é™¢</div>
  </div>

  <!-- è‡ªå®šä¹‰åœ°å›¾å¼¹çª— -->
  <div id="custom-map-modal">
    <div class="modal-content">
      <h3 style="margin:0">è¾“å…¥è‡ªå®šä¹‰åœ°å›¾</h3>
      <textarea id="map-input" placeholder="è¯·åœ¨æ­¤ç²˜è´´åœ°å›¾æ•°æ®...&#10;######&#10;#@ $.#&#10;######"></textarea>
      <div class="modal-actions">
        <button class="func-btn" style="background:#f1f3f5" onclick="document.getElementById('custom-map-modal').style.display='none'">å–æ¶ˆ</button>
        <button class="func-btn" style="background:var(--primary-color);color:white;box-shadow:0 4px 0 #0056b3" id="btn-load-map">åŠ è½½</button>
      </div>
    </div>
  </div>

  <!-- å¯†ç è¾“å…¥å¼¹çª— -->
  <div id="password-modal">
    <div class="modal-content">
      <h3 style="margin:0 0 15px 0">ğŸ”’ å®‰å…¨è®¿é—®åè®®</h3>
      <p style="margin:0 0 10px 0;font-size:14px;color:#666">è¯·è¾“å…¥è®¿é—®å¯†é’¥ä»¥è§£é”éšè—åŒºï¼š</p>
      <input type="text" id="password-input" placeholder="è¾“å…¥å¯†é’¥..." style="width:100%;padding:10px;border:2px solid #eee;border-radius:10px;box-sizing:border-box;font-size:16px;margin-bottom:15px;outline:none;">
      <div id="password-error" style="color:red;font-size:14px;margin-bottom:10px;display:none;font-weight:bold;">ğŸš« å¯†é’¥æ— æ•ˆ</div>
      <div class="modal-actions">
        <button class="func-btn" style="background:#f1f3f5" onclick="closePasswordModal()">å–æ¶ˆ</button>
        <button class="func-btn" style="background:var(--primary-color);color:white;box-shadow:0 4px 0 #0056b3" id="btn-verify-password">éªŒè¯</button>
      </div>
    </div>
  </div>

<script>
/** å…³å¡æ•°æ® */
const levels = [
    // å…³å¡ 1
  `_#####
##---#
#.@$-#
######`,
  // å…³å¡ 2
  `######
#---.#
#-$$.#
#-$@.#
######`,
  // å…³å¡ 3
  `######
#----#
#-$@.#
#-#$.#
#-$-.#
######`,
  // å…³å¡ 4
    `#####_
#..-#_
#-@$##
#-$--#
##---#
_#####`,
  // å…³å¡ 5
  `__#####_
###---#_
#.@$--#_
###-$.#_
#.##$-#_
#-#-.-##
#$-*$$.#
#---.--#
########`,
  // å…³å¡ 6
`____#####_____
____#---#_____
____#$--#_____
__###--$##____
__#--$-$-#____
###-#-##-#####
#---#-##---..#
#-$--$--@--..#
#########--..#
________######`,
  // å…³å¡ 7
  `############__
#..--#-----###
#..--#-$--$--#
#..--#$####--#
#..----@-##--#
#..--#-#--$-##
######-##$-$-#
__#-$--$-$-$-#
__#----#-----#
__############`,
  // å…³å¡ 8
  `#####__
#---#__
#---###
#$$$@-#
#...--#
#######`,
  // å…³å¡ 9
  `####__
#--#__
#--#__
#--###
#.$$@#
#--.-#
#--###
####__`,
  // å…³å¡ 10
  `#######
#-----#
#-$$$.#
##-#@.#
_#-#-.#
_#--#-#
_##---#
__#####`,
  // å…³å¡ 11
  `_________#####
_________#---#
##########-#-#
#.-----#--$--#
#.--@--#----##
#.#-#######--#
#---------$$-#
##--#####----#
_####___######`,
  // å…³å¡ 12
  `_#######__
_#-----###
##-###$--#
#--..-$--#
#--.##$-##
###-#-@##_
__#---##__
__#####___`,
  // å…³å¡ 13
  `######____
#----#####
#---$-$--#
###$...@-#
__#--#####
__####____`,
  // å…³å¡ 14
  `#######
#@-$.-#
#--$--#
#.-$-$#
#-.-#.#
#######`
];

/** éšè—å…³å¡æ•°æ®ï¼ˆç§‘æŠ€åºŸåœŸé£ - æ›´æ–°ç‰ˆï¼‰ */
const hiddenLevelData = `#####_
#-@-#_
#...#_
#$$$##
#----#
#----#
######`;

/** å…¨å±€çŠ¶æ€ */
let floorMap = [], objMap = [];
let rows = 0, cols = 0;
let playerX = 0, playerY = 0;
let gameWon = false;
let undoStack = [];
let currentLevelData = "";
let isHiddenLevelActive = false; // æ˜¯å¦å¤„äºéšè—å…³å¡æ¨¡å¼

/** åˆå§‹åŒ–ç•Œé¢ */
function initUI() {
  const container = document.getElementById('level-scroll-container');
  
  // ç”Ÿæˆæ ‡å‡†å…³å¡æŒ‰é’®
  levels.forEach((lvl, index) => {
    const btn = document.createElement('button');
    btn.className = 'level-btn';
    btn.textContent = `ç¬¬ ${index + 1} å…³`; 
    btn.onclick = () => {
      document.querySelectorAll('.level-btn').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
      loadLevelFromText(lvl, false); // åŠ è½½æ™®é€šå…³å¡
      btn.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' });
    };
    container.appendChild(btn);
  });

  // ç”Ÿæˆéšè—å…³å¡é”æŒ‰é’®
  const lockBtn = document.createElement('button');
  lockBtn.className = 'level-btn';
  lockBtn.innerHTML = 'ğŸ”’';
  lockBtn.id = 'btn-secret-level'; // ç»™ä¸ªIDæ–¹ä¾¿æ“ä½œ
  lockBtn.title = "è¾“å…¥å¯†ç è§£é”";
  lockBtn.onclick = () => {
    // å¦‚æœå·²ç»è§£é”å¹¶æ¿€æ´»ï¼Œç›´æ¥é‡è½½
    if (lockBtn.dataset.unlocked === "true") {
        document.querySelectorAll('.level-btn').forEach(b => b.classList.remove('active'));
        lockBtn.classList.add('active');
        loadLevelFromText(hiddenLevelData, true);
        return;
    }

    // å¦åˆ™æ‰“å¼€å¯†ç å¼¹çª—
    openPasswordModal();
  };
  container.appendChild(lockBtn);

  // é»˜è®¤åŠ è½½ç¬¬ä¸€å…³
  container.children[0].classList.add('active');
  loadLevelFromText(levels[0], false);
}

/** å¯†ç å¼¹çª—ç›¸å…³é€»è¾‘ */
function openPasswordModal() {
    const modal = document.getElementById('password-modal');
    const input = document.getElementById('password-input');
    const errorMsg = document.getElementById('password-error');
    
    input.value = "";
    errorMsg.style.display = "none";
    modal.style.display = "flex";
    
    // ç¨å¾®å»¶è¿Ÿèšç„¦ï¼Œé˜²æ­¢ç§»åŠ¨ç«¯é”®ç›˜è·³å‡ºé—®é¢˜
    setTimeout(() => input.focus(), 100);
}

function closePasswordModal() {
    document.getElementById('password-modal').style.display = "none";
}

// ç»‘å®šéªŒè¯æŒ‰é’®
document.getElementById('btn-verify-password').onclick = verifyPassword;

// æ”¯æŒå›è½¦é”®æäº¤å¯†ç 
document.getElementById('password-input').addEventListener("keypress", function(event) {
    if (event.key === "Enter") {
        event.preventDefault();
        verifyPassword();
    }
});

function verifyPassword() {
    const input = document.getElementById('password-input');
    const errorMsg = document.getElementById('password-error');
    const lockBtn = document.getElementById('btn-secret-level');
    
    if (input.value === "LineB") {
        // å¯†ç æ­£ç¡®
        closePasswordModal();
        alert("ğŸ”“ è®¿é—®æˆæƒæˆåŠŸï¼šå·²è¿›å…¥åºŸåœŸæ‰‡åŒº 15");
        
        // æ›´æ–°æŒ‰é’®çŠ¶æ€
        document.querySelectorAll('.level-btn').forEach(b => b.classList.remove('active'));
        lockBtn.classList.add('active');
        lockBtn.textContent = "ç¬¬ 15 å…³";
        lockBtn.dataset.unlocked = "true"; // æ ‡è®°ä¸ºå·²è§£é”
        
        // åŠ è½½å…³å¡
        loadLevelFromText(hiddenLevelData, true);
        lockBtn.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' });
    } else {
        // å¯†ç é”™è¯¯
        errorMsg.style.display = "block";
        input.value = "";
        input.focus();
        // éœ‡åŠ¨æç¤º
        if(navigator.vibrate) navigator.vibrate(200);
    }
}

/** åŠ è½½å…³å¡ (æ–°å¢ isSecret å‚æ•°) */
function loadLevelFromText(mapText, isSecret = false) {
  gameWon = false;
  undoStack = [];
  currentLevelData = mapText;
  isHiddenLevelActive = isSecret; // æ›´æ–°æ¨¡å¼çŠ¶æ€
  showStatus("");

  // åˆ‡æ¢ä¸»é¢˜
  if (isSecret) {
      document.body.classList.add('theme-wasteland');
  } else {
      document.body.classList.remove('theme-wasteland');
  }

  const lines = mapText.replace(/\r/g, "").split("\n").filter(l => l.trim().length > 0);
  rows = lines.length;
  cols = 0;
  lines.forEach(l => { if (l.length > cols) cols = l.length; });

  floorMap = [];
  objMap = [];
  playerX = -1;
  playerY = -1;

  for (let y = 0; y < rows; y++) {
    floorMap[y] = [];
    objMap[y] = [];
    const line = lines[y] || "";
    for (let x = 0; x < cols; x++) {
      let ch = line[x] || " ";
      if(ch === '"') ch = " ";

      if (ch === '#') { floorMap[y][x] = '#'; objMap[y][x] = ' '; }
      else if (ch === '_') { floorMap[y][x] = '_'; objMap[y][x] = ' '; }
      else if (ch === '.') { floorMap[y][x] = '.'; objMap[y][x] = ' '; }
      else if (ch === '@') { floorMap[y][x] = '-'; objMap[y][x] = '@'; playerX = x; playerY = y; }
      else if (ch === '$') { floorMap[y][x] = '-'; objMap[y][x] = '$'; }
      else if (ch === '*') { floorMap[y][x] = '.'; objMap[y][x] = '$'; }
      else { floorMap[y][x] = '-'; objMap[y][x] = ' '; }
    }
  }

  drawBoard();
  adjustBoardSize();
}

/** ç»˜åˆ¶åœ°å›¾ */
function drawBoard() {
  const board = document.getElementById("game-board");
  board.innerHTML = "";
  // æ³¨æ„ï¼šè¿™é‡Œå…ˆæš‚è®¾ rows/colsï¼ŒçœŸæ­£çš„å¤§å°å’Œæ ¼å­å½¢çŠ¶ç”± adjustBoardSize å¼ºåˆ¶è¦†ç›–
  
  for (let y = 0; y < rows; y++) {
    for (let x = 0; x < cols; x++) {
      const tile = document.createElement("div");
      tile.className = "tile";
      
      const fch = floorMap[y][x];
      const och = objMap[y][x];

      // åº•å±‚ï¼šå¢™ã€åœ°ã€ç»ˆç‚¹
      if (fch === '#') tile.classList.add("wall");
      else if (fch === '_') tile.classList.add("outside");
      else if (fch === '-') tile.classList.add("floor");
      else if (fch === '.') tile.classList.add("goal"); 

      // ä¸Šå±‚ï¼šäººã€ç®±å­
      if (och === '@') tile.classList.add("player");
      else if (och === '$') {
        tile.classList.add(fch === '.' ? "box-on-goal" : "box");
      }

      board.appendChild(tile);
    }
  }
  
  requestAnimationFrame(adjustBoardSize);
  checkWin();
}

/** æ ¸å¿ƒä¿®å¤ï¼šé€‚é…å±å¹•å°ºå¯¸ & å¼ºåˆ¶æ­£æ–¹å½¢ */
function adjustBoardSize() {
  const container = document.getElementById('game-container');
  const board = document.getElementById('game-board');
  
  const maxWidth = container.clientWidth;
  const maxHeight = container.clientHeight;
  
  const sizeByWidth = Math.floor(maxWidth / cols);
  const sizeByHeight = Math.floor(maxHeight / rows);
  const cellSize = Math.min(sizeByWidth, sizeByHeight, 60); 

  board.style.width = `${cellSize * cols}px`;
  board.style.height = `${cellSize * rows}px`;
  
  board.style.gridTemplateColumns = `repeat(${cols}, ${cellSize}px)`;
  board.style.gridTemplateRows = `repeat(${rows}, ${cellSize}px)`;

  const tiles = document.querySelectorAll('.tile');
  const fontSize = Math.floor(cellSize * 0.8) + "px";
  tiles.forEach(t => {
      t.style.fontSize = fontSize;
  });
}

/** èƒœåˆ©æ£€æµ‹ */
function checkWin() {
  let allDone = true;
  for(let y=0; y<rows; y++){
      for(let x=0; x<cols; x++){
          if(objMap[y][x] === '$' && floorMap[y][x] !== '.') {
              allDone = false;
              break;
          }
      }
      if(!allDone) break;
  }

  if (allDone && !gameWon) {
    gameWon = true;
    showStatus(isHiddenLevelActive ? "ğŸ¤– ç³»ç»Ÿæ¢å¤ï¼šæ ¸å¿ƒå·²å°±ä½ï¼" : "ğŸ‰ æ­å–œï¼å®Œç¾é€šå…³ï¼");
    if(navigator.vibrate) navigator.vibrate([100, 50, 100, 50, 200]);
  }
}

function showStatus(msg) {
  const el = document.getElementById("status-overlay");
  el.textContent = msg;
  if(msg) el.classList.add('show');
  else el.classList.remove('show');
}

/** ç§»åŠ¨é€»è¾‘ */
function movePlayer(dx, dy) {
  if (gameWon) return;

  const newX = playerX + dx;
  const newY = playerY + dy;

  if (newY < 0 || newY >= rows || newX < 0 || newX >= cols) return;
  if (floorMap[newY][newX] === '#' || floorMap[newY][newX] === '_') return;

  const targetObj = objMap[newY][newX];
  let moveRecord = {
    px: playerX, py: playerY, nx: newX, ny: newY,
    box: null 
  };

  if (targetObj === ' ') {
    objMap[playerY][playerX] = ' ';
    objMap[newY][newX] = '@';
    playerX = newX; playerY = newY;
    undoStack.push(moveRecord);
  } else if (targetObj === '$') {
    const boxNextX = newX + dx;
    const boxNextY = newY + dy;
    if (boxNextY < 0 || boxNextY >= rows || boxNextX < 0 || boxNextX >= cols) return;
    if (["#", "_"].includes(floorMap[boxNextY][boxNextX])) return;
    if (["$", "@"].includes(objMap[boxNextY][boxNextX])) return;

    objMap[playerY][playerX] = ' ';
    objMap[newY][newX] = '@';
    objMap[boxNextY][boxNextX] = '$';
    
    moveRecord.box = { ox: newX, oy: newY, nx: boxNextX, ny: boxNextY };
    playerX = newX; playerY = newY;
    undoStack.push(moveRecord);
  }

  if(navigator.vibrate) navigator.vibrate(15); 
  drawBoard();
}

/** æ’¤å›é€»è¾‘ï¼ˆæœ€ç»ˆä¿®å¤ç‰ˆï¼‰ */
function undoMove() {
  if (undoStack.length === 0) return;
  const last = undoStack.pop();

  // 1. æ¸…ç†ç©å®¶å½“å‰ä½ç½®ï¼ˆå¿…é¡»ä½¿ç”¨è®°å½•ä¸­çš„ nx/nyï¼Œä¸èƒ½ä¾èµ– playerX å…¨å±€å˜é‡ï¼Œé˜²æ­¢åå·®ï¼‰
  objMap[last.ny][last.nx] = ' ';

  // 2. å¦‚æœæœ‰ç®±å­ï¼Œæ¸…ç†ç®±å­çš„å½“å‰ä½ç½®ï¼Œå¹¶æ¢å¤ç®±å­åˆ°æ—§ä½ç½®
  if (last.box) {
    // æ¸…ç†ç®±å­ç°åœ¨çš„åæ ‡
    objMap[last.box.ny][last.box.nx] = ' ';
    // æ¢å¤ç®±å­åˆ°åŸæ¥çš„åæ ‡ (last.box.ox/oy)
    // æ³¨æ„ï¼šbox.ox å…¶å®ç­‰äº last.nxï¼Œæ‰€ä»¥è¿™é‡Œä¼šè¦†ç›–ç¬¬1æ­¥çš„æ¸…ç†ï¼Œæ­£ç¡®åœ°æŠŠç®±å­æ”¾å›ç©å®¶é¢å‰
    objMap[last.box.oy][last.box.ox] = '$';
  }

  // 3. æ¢å¤ç©å®¶åˆ°æ—§ä½ç½®
  objMap[last.py][last.px] = '@';

  // 4. æ›´æ–°å…¨å±€åæ ‡
  playerX = last.px;
  playerY = last.py;

  // 5. é‡ç½®æ¸¸æˆçŠ¶æ€
  gameWon = false;
  showStatus("");
  drawBoard();
}

/* ================= äº‹ä»¶ç›‘å¬ ================= */
window.addEventListener("resize", adjustBoardSize);

document.addEventListener("keydown", (e) => {
  if (["ArrowUp", "ArrowDown", "ArrowLeft", "ArrowRight"].includes(e.key)) {
    e.preventDefault();
  }
  if (e.key === "ArrowUp") movePlayer(0, -1);
  else if (e.key === "ArrowDown") movePlayer(0, 1);
  else if (e.key === "ArrowLeft") movePlayer(-1, 0);
  else if (e.key === "ArrowRight") movePlayer(1, 0);
});

const bindBtn = (id, dx, dy) => {
  const btn = document.getElementById(id);
  btn.addEventListener("touchstart", (e) => { e.preventDefault(); movePlayer(dx, dy); });
  btn.addEventListener("click", () => movePlayer(dx, dy));
};
bindBtn("btn-up", 0, -1);
bindBtn("btn-down", 0, 1);
bindBtn("btn-left", -1, 0);
bindBtn("btn-right", 1, 0);

document.getElementById("btn-undo").onclick = undoMove;
document.getElementById("btn-restart").onclick = () => loadLevelFromText(currentLevelData, isHiddenLevelActive);

// è‡ªå®šä¹‰åœ°å›¾
const modal = document.getElementById("custom-map-modal");
document.getElementById("btn-show-custom").onclick = () => {
  modal.style.display = "flex";
  document.getElementById("map-input").focus();
};
document.getElementById("btn-load-map").onclick = () => {
  const txt = document.getElementById("map-input").value;
  if(txt.trim()) {
    loadLevelFromText(txt, false); // è‡ªå®šä¹‰åœ°å›¾è§†ä¸ºæ™®é€šæ¨¡å¼
    modal.style.display = "none";
    document.querySelectorAll('.level-btn').forEach(b => b.classList.remove('active'));
  }
};

// è§¦æ‘¸æ»‘åŠ¨
let touchStartX = 0;
let touchStartY = 0;
const gameContainer = document.getElementById("game-container");

gameContainer.addEventListener('touchstart', function(e) {
    touchStartX = e.changedTouches[0].screenX;
    touchStartY = e.changedTouches[0].screenY;
    e.preventDefault();
}, {passive: false});

gameContainer.addEventListener('touchend', function(e) {
    let touchEndX = e.changedTouches[0].screenX;
    let touchEndY = e.changedTouches[0].screenY;
    handleSwipe(touchStartX, touchStartY, touchEndX, touchEndY);
    e.preventDefault();
}, {passive: false});

function handleSwipe(sx, sy, ex, ey) {
    let dx = ex - sx;
    let dy = ey - sy;
    if (Math.abs(dx) < 30 && Math.abs(dy) < 30) return;
    if (Math.abs(dx) > Math.abs(dy)) {
        movePlayer(dx > 0 ? 1 : -1, 0);
    } else {
        movePlayer(0, dy > 0 ? 1 : -1);
    }
}

// å¯åŠ¨
initUI();

</script>
</body>
</html>
